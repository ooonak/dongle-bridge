# An application located within a workspace, but outside the zephyr repository
# itself, is referred to as a Zephyr workspace application.
# zephyrproject/
# ├─── .west/
# │    └─── config
# ├─── zephyr/
# ├─── bootloader/
# ├─── modules/
# ├─── tools/
# ├─── <vendor/private-repositories>/
# └─── applications/
#      └── app/

name: Zephyr Build & Test v4.3

on:
  push:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      # --- Checkout the repo into 'app' folder ---
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: applications  # your repo root will be in $GITHUB_WORKSPACE/applications

      # --- Set up Python 3.12 ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12

      # --- Cache Zephyr SDK ---
      - name: Cache Zephyr SDK
        uses: actions/cache@v3
        id: sdk-cache
        with:
          path: ~/.zephyr-sdk
          key: zephyr-sdk-0.17.4
          restore-keys: |
            zephyr-sdk-0.17.4

      # --- Cache pip packages ---
      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-

      # --- Setup Zephyr environment ---
      - name: Setup Zephyr project
        uses: zephyrproject-rtos/action-zephyr-setup@v1
        with:
          app-path: applications
          toolchains: arm-zephyr-eabi:x86_64-zephyr-elf

      # --- Initialize west workspace ---
      - name: Initialize west
        working-directory: applications
        run: |
          # Only initialize if workspace metadata does not exist
          if [ ! -d "$GITHUB_WORKSPACE/.west" ]; then
            west init -l .
          fi
          west update

      # --- Build nRF52840 Dongle ---
      - name: Build nRF52840 Dongle
        working-directory: applications
        run: |
          west build -p -b nrf52840dongle app

      # --- Run native_sim tests with Twister ---
      - name: Run native_sim tests
        working-directory: applications
        run: |
          west twister -v -p native_sim -T app/tests

      # --- Sanitizer build for native_sim ---
      - name: Build and run tests with Address Sanitizer
        working-directory: applications
        continue-on-error: true
        run: |
          west build -p -b native_sim -d build/ci-native-asan app/tests/app_logic -- \
            -DZEPHYR_TOOLCHAIN_VARIANT=llvm \
            -DEXTRA_CONF_FILE=$(pwd)/overlays/sanitizers.conf \
            -DSANITIZER_BUILD=1
          west build -t run -d build/ci-native-asan
